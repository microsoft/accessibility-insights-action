# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

parameters:
    - name: environment
      displayName: deployment environment
      type: string
    - name: visibility
      displayName: marketplace visibility
      type: string

steps:
    - download: none
    - task: TfxInstaller@3
      inputs:
          version: 'v0.7.x'
    - task: DownloadBuildArtifacts@0
      inputs:
          buildType: 'current'
          downloadType: 'single'
          artifactName: '${{ parameters.environment }}-vsix'
          downloadPath: '$(System.DefaultWorkingDirectory)'
    - task: AzureCLI@2
      displayName: Get accessToken
      name: getAccessToken
      inputs:
          azureSubscription: a11y-insights-action-prod
          scriptType: pscore
          scriptLocation: 'inlineScript'
          inlineScript: |
              $accessToken = az account get-access-token --resource 499b84ac-1321-427f-aa17-267ca6975798 --query "accessToken" --output tsv
              write-host "##vso[task.setsecret]$accessToken"
              write-host "##vso[task.setendpoint id=$env:MARKETPLACE_SERVICE_CONNECTION;field=authParameter;key=password]$accessToken"
          env:
              MARKETPLACE_SERVICE_CONNECTION: '9956b57f-a4b0-44bf-96fc-ac1ef0dc3642'
    - task: PublishAzureDevOpsExtension@3
      inputs:
          connectTo: 'VsTeam'
          connectedServiceName: 'a11y-insights-vs-marketplace'
          fileType: 'vsix'
          vsixFile: '${{ parameters.environment }}-vsix/${{ parameters.environment }}.vsix'
          publisherId: '$(PublisherID)'
          extensionId: '$(ExtensionID)'
          extensionName: '$(ExtensionName)'
          updateTasksVersion: false
          extensionVisibility: '${{parameters.visibility}}'
          extensionPricing: 'free'
          shareWith: 'accessibility-insights-private'
    - bash: |
          echo "to use the published extension, reference its fully-qualified name"
          echo $(PublisherID).$(ExtensionID).task.accessibility-insights@MAJOR_VERSION
