# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

trigger: # trigger only affects CI builds
    branches:
        include:
            - main

# Do not edit. The resources tell us where our 1ES pipeline is being pulled from:
resources:
    repositories:
        - repository: 1esPipelines
          type: git
          name: 1ESPipelineTemplates/1ESPipelineTemplates
          ref: refs/tags/release

extends:
    # Do not edit. This is the 1ES template that holds different SDL and compliance tasks that the template injects into the pipeline.
    # It uses the Official template because it's a production pipeline.
    template: v1/1ES.Official.PipelineTemplate.yml@1esPipelines

    parameters:
        # Accessibility Insights team's 1ES hosted pool.
        # This variable is saved in Azure DevOps from the "Edit" pipeline view.
        pool:
            name: $(a11yInsightsPool)
            image: windows-2022-secure
            os: windows

        sdl:
            # Suppressing CodeQL (Semmle) failures that we are unable to fix or are false positives.
            # https://eng.ms/docs/cloud-ai-platform/devdiv/one-engineering-system-1es/1es-docs/1es-pipeline-templates/features/sdlanalysis/baselines#azure-devops-based-builds
            suppression:
                suppressionFile: $(Build.SourcesDirectory)\guardian\SDL\.gdnsuppress

        stages:
            - stage: Stage
              jobs:
                  - job: 'BuildAndCheckCodeStyling'
                    steps:
                        - task: NodeTool@0
                          inputs:
                              versionSpec: '16.x'
                          displayName: use node 16.x

                        - script: yarn install --immutable
                          displayName: Install dependencies

                        - script: yarn copyright:check
                          displayName: Check copyright headers

                        - script: yarn format:check
                          displayName: Check code formatting

                        - script: yarn cbuild
                          displayName: Build

                        - script: yarn lint:check
                          displayName: Check for lint errors

                        - script: yarn test --ci --coverage
                          displayName: Run tests
                          env:
                              NODE_OPTIONS: --max_old_space_size=4096

                        - script: yarn publish-code-coverage -t $(CODECOV_TOKEN)
                          displayName: Publish code coverage to codecov

                        - script: yarn test:e2e --verbose
                          displayName: 'Run e2e tests'

                  - job: 'PublishBuildDrops'
                    templateContext:
                        outputs:
                            - output: pipelineArtifact
                              targetPath: $(System.DefaultWorkingDirectory)/packages/ado-extension/dist
                              artifactName: ado-extension-drop
                    steps:
                        - task: NodeTool@0
                          inputs:
                              versionSpec: '16.x'
                          displayName: use node 16.x

                        - script: yarn install --immutable
                          displayName: Install dependencies

                        - script: yarn cbuild
                          displayName: Build

                        - task: msospo.ospo-extension.8d7f9abb-6896-461d-9e25-4f74ed65ddb2.notice@0
                          displayName: 'generate NOTICE.html file'
                          retryCountOnTaskFailure: 3
                          inputs:
                              outputfile: '$(System.DefaultWorkingDirectory)/NOTICE.html'
                              outputformat: html

                        - task: CopyFiles@2
                          displayName: 'Copy Notices.html to: ado-extension'
                          inputs:
                              Contents: |
                                  $(System.DefaultWorkingDirectory)/NOTICE.html

                              TargetFolder: '$(System.DefaultWorkingDirectory)/packages/ado-extension/dist'

                        - bash: |
                              echo '<!--
                              Copyright (c) Microsoft Corporation. All rights reserved.
                              Licensed under the MIT License.
                              -->
                                            
                              # About
                                            
                              This release was generated from this source tree [$(Build.SourceVersion)](https://github.com/microsoft/accessibility-insights-action/tree/$(Build.SourceVersion)).
                              ' > '$(System.DefaultWorkingDirectory)/packages/ado-extension/dist/RELEASE_COMMIT.md'

                          displayName: 'Generate Release README Info to: ado-extension'
