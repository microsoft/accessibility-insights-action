# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

# This pipeline was generated from the classic pipeline "Create ESRP service connection" on 2023-12-07 with https://aka.ms/1ESPTMigration (v1.1.0): https://dev.azure.com/accessibility-insights-private/Accessibility%20Insights%20(private)/_build?definitionId=133
#
# The following items require attention:
# Variables were exported from the classic pipeline, confirm that `variables` values do not contain private information. If a variable contains private information, follow the guidance on handling secret variables: https://learn.microsoft.com/en-us/azure/devops/pipelines/process/set-secret-variables
# Agent Queue 'Azure Pipelines' was used with unrecognized Agent Specification, vmImage property must be specified to determine image - https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops&tabs=yaml#software
# No trigger found, defaulting to 'none'. Update the trigger as needed.
# No name found, setting the default value '$(Date:yyyyMMdd).$(Rev:r)'. This value determines how your pipeline runs are numbered. Update the name as needed: https://learn.microsoft.com/en-us/azure/devops/pipelines/process/run-number?view=azure-devops&tabs=yaml

name: $(Date:yyyyMMdd).$(Rev:r)

variables:
    - name: Codeql.SkipTaskAutoInjection
      value: true
    - group: a11y-insights-esrp-signing-certificate

resources:
    repositories:
        - repository: self
          type: git
          ref: refs/heads/main
        - repository: 1esPipelines
          type: git
          name: 1ESPipelineTemplates/1ESPipelineTemplates
          ref: refs/tags/release

trigger: none

extends:
    template: v1/1ES.Official.PipelineTemplate.yml@1esPipelines
    parameters:
        pool:
            os: windows
            image: windows-2022-secure
            name: $(a11yInsightsPool)
        stages:
            - stage: Stage
              jobs:
                  - job: Job_1
                    displayName: Create ESRP service connection
                    steps:
                        - checkout: self
                          clean: true
                          fetchTags: false
                        - task: CmdLine@2
                          displayName: Show environment variables
                          inputs:
                              script: set
                        - task: AzureCLI@3
                          displayName: 'Fetch profile for Service Principal'
                          inputs:
                            azureSubscription: 'a11y-insights-action-prod'
                            scriptType: pscore
                            scriptLocation: inlineScript
                            inlineScript: |
                                az rest -u https://app.vssps.visualstudio.com/_apis/profile/profiles/me --resource 499b84ac-1321-427f-aa17-267ca6975798
